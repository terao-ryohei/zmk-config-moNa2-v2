# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a ZMK firmware configuration for the moNa2 split keyboard with the following features:
- Split keyboard design (left/right halves)
- Based on Seeeduino XIAO BLE microcontroller
- PMW3610 trackball sensor on the right half with auto-layer and scroll mode support
- Rotary encoder on the left half
- RGB LED support via rgbled_adapter
- ZMK Studio support for live configuration
- 40-key layout with 7 layers (default, numbers/symbols, special chars, navigation/media, system, mouse, scroll)

## Building Firmware

The firmware is built automatically via GitHub Actions on push/PR. The build configuration is defined in `build.yaml`.

**Build targets:**
- `mona2_r` - Right half with trackball and ZMK Studio (uses `studio-rpc-usb-uart` snippet)
- `mona2_l` - Left half with encoder
- `settings_reset` - Settings reset shield

Build artifacts (.uf2 files) are generated by GitHub Actions and can be flashed to the keyboard.

## Repository Structure

**Hardware Definition:**
- `boards/shields/mona2/` - ZMK shield definition for moNa2 keyboard
  - `mona2.dtsi` - Common device tree includes (matrix transform, kscan, physical layout, trackball listener, encoder)
  - `mona2_l.overlay` - Left half GPIO configuration (encoder on xiao_d 0/5)
  - `mona2_r.overlay` - Right half GPIO configuration with PMW3610 trackball via SPI (pins: CS=P0.09, SCLK=P0.05, SDIO=P0.04, MOTION=P0.02) and input processors for scroll mode
  - `Kconfig.shield` / `Kconfig.defconfig` - Kconfig shield definitions

**Keymap Configuration:**
- `config/mona2.keymap` - Main keymap file with layer definitions, combos, macros, and behaviors
- `config/mona2_r.conf` - Right half config (PMW3610 settings, RGB LED, ZMK Studio, Bluetooth, encoder, battery)
- `config/mona2_l.conf` - Left half config (encoder, battery reporting)

**Dependencies:**
- `config/west.yml` - West manifest defining ZMK and module dependencies:
  - `zmk` @ v0.3.0 (zmkfirmware)
  - `zmk-pmw3610-driver` (badjeff) - PMW3610 trackball driver
  - `zmk-rgbled-widget` (caksoylar) - RGB LED layer/battery indicators
  - `zmk-input-processor-keybind` (zettaface) - Input processor keybind support

## Hardware-Specific Notes

**COROPIT Trackball Configuration:**

For COROPIT trackball users, enable axis inversion in `mona2_r.overlay:57-58`:
```
invert-x; //COROPIT版ではコメントアウトを外す
invert-y; //COROPIT版ではコメントアウトを外す
```

**Trackball Features:**
- Default layer: Mouse movement with Y-axis inversion
- Layer 3: Scroll mode with custom input processors (X-axis inversion, 1/5 scroll scaling)
- CPI set to 600 in overlay file
- Auto-layer support available but commented out (see `mona2.dtsi:96`)

**Key Configuration Details:**
- Matrix: 4 rows × 11 columns (col2row diode direction)
- Default combos: positions 39+38 = layer 4 + ESC, positions 11+12 = TAB
- Behavior modifications: `&mt` (balanced, quick-tap-ms=0), `&lt` (balanced, quick-tap-ms=300)
- Custom behaviors: `lt_to_layer_0`, `scroll_up_down`, `scroll_right_left`
- Encoder triggers-per-rotation: 10

## Development Workflow

1. Edit keymap in `config/mona2.keymap`
2. Modify board-specific settings in `config/mona2_r.conf` or `config/mona2_l.conf`
3. Hardware changes require editing `.overlay` and `.dtsi` files in `boards/shields/mona2/`
4. Push to trigger GitHub Actions build via `.github/workflows/build.yml`
5. Download .uf2 files from Actions artifacts and flash to keyboard

## Important Configuration Files

- PMW3610 trackball config: `mona2_r.overlay:49-62` and `mona2_r.conf:1-7`
- RGB LED settings: `mona2_r.conf:18-21`
- ZMK Studio: `mona2_r.conf:23-25` (locking disabled)
- Bluetooth intervals: `mona2_r.conf:27-29`
- Input processors for trackball: `mona2_r.overlay:68-82` (scroll mode) and `mona2.dtsi:89-97` (default mode)
